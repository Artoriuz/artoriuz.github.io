<!DOCTYPE html>
<html lang="en">

<head>
        <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135192850-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-135192850-1');
    </script>

    <title>Mathematically Evaluating mpv's Resampling Algorithms</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="./css/default.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Roboto+Slab&display=swap" rel="stylesheet">
</head>

<body>
    <header>
        <hgroup>
            <h1>
                mpv Resampling
            </h1>
            <h2>A sequel in the making</h2>
        </hgroup>
    </header>
    <nav>
        <menu>
            <a href="../index.html">Home</a>
            <a href="https://github.com/Artoriuz">GitHub</a>
            <a href="https://www.linkedin.com/in/jvrchrisostomo/">LinkedIn</a>
        </menu>
    </nav>
    <section>
        <h3 id="introduction">Introduction</h3>
        <p>
            This page is meant to be treated as a follow-up to this scaler comparison done with <a href="https://artoriuz.github.io/blog/imagemagick_resampling.html">ImageMagick</a>. I'm only going to talk about niche topics here, 
            so just refer to that other page if you only want to read about scalers.
        </p>
        <h3 id="upsampling_shaders">Upsampling Shaders</h3>
        <p>
            The mpv community has written several <s>meme</s> shaders you can use to upsample video in real time, and the rationale is that they can potentially achieve higher quality than the built-in methods. I still do not have a good way of 
            automating mpv tests and therefore I'll have to stick to a single test image, which is still going to be violet.png just because I'm familiarised with it. If this is your first time reading these posts, this is what violet.png looks like:
        </p>
        <p>
            <img src="./images/mpv_upscaling/upsampling/violet.png" alt="Violet" class="center" width="960" height="540">
        </p>
        <p>
            The small number of samples under test makes this very unscientific, but it is what it is.
        </p>
        <h3 id="upsampling_methodology">Upsampling Methodology</h3>
        <p>
            The following shaders were "benchmarked":
            <ol>
              <li><a href="https://github.com/bjin/mpv-prescalers">RAVU</a></li>
              <li><a href="https://github.com/bjin/mpv-prescalers">NNEDI3</a></li>
              <li><a href="https://github.com/igv/FSRCNN-TensorFlow">FSRCNNX</a></li>
              <li><a href="https://github.com/bloc97/Anime4K">Anime4K</a></li>
              <li><a href="https://gist.github.com/agyild/82219c545228d70c5604f865ce0b0ce5">FSR</a></li>
            </ol>
            I've also added polar Lanczos to the mix just to have a reference point, but feel free to send me any other shaders you would like to get scored. 
            For Anime4K I'm using the <a href="https://github.com/bloc97/Anime4K/blob/815b122284304e6e1e244a8cf6a160eeaa07040c/GLSL_Instructions.md">"C" mode</a> which is defined as <inline_code>Upscale_Denoise -> Upscale</inline_code>.
        </p>
        <p>
            The test image is downsampled with:
        </p>                    
        <code>magick convert violet.png -colorspace rgb -filter box -resize 50% -colorspace srgb downscaled.png</code>
        <p>
            It is then converted to grayscale with:
        </p>
        <code>magick convert downscaled.png -colorspace gray downscaled.png</code>
        <p>
            We need to convert them to grayscale because some of these shaders do not have RGB support.
        </p>
        <p>
            The images were then upsampled back with:
        </p>
        <code>mpv --no-config --vo=gpu-next --no-hidpi-window-scale --window-scale=2.0 --pause=yes --screenshot-format=png --sigmoid-upscaling --deband=no --dither-depth=no --screenshot-high-bit-depth=no --glsl-shader="path/to/meme/shader" downscaled.png</code>
        <p>
          Unfortunately, for NEEDI3 we have to switch back to <inline_code>--vo=gpu</inline_code> so we can use <inline_code>--no-scaler-resizes-only</inline_code> to fix the half-pixel shift introduced by the shader.
        </p>
        <h3 id="upsampling_results">Upsampling Results</h3>
        <p>
          <table>
            <tbody>
              <tr>
                <td>Shader/Filter</td>
                <td>MAE</td>
                <td>PSNR</td>
                <td>SSIM</td>
                <td>MS-SSIM</td>
                <td></td>
                <td>MAE (N)</td>
                <td>PSNR (N)</td>
                <td>SSIM (N)</td>
                <td>MS-SSIM (N)</td>
                <td></td>
                <td>Mean</td>
              </tr>
              <tr>
                <td>ravu-zoom-ar-r3</td>
                <td>0.0035</td>
                <td>41.0016</td>
                <td>0.9886</td>
                <td>0.9987</td>
                <td></td>
                <td>1.0000</td>
                <td>0.9934</td>
                <td>1.0000</td>
                <td>0.9035</td>
                <td></td>
                <td>0.9742</td>
              </tr>
              <tr>
                <td>ravu-zoom-r3</td>
                <td>0.0038</td>
                <td>41.0404</td>
                <td>0.9872</td>
                <td>0.9990</td>
                <td></td>
                <td>0.8964</td>
                <td>1.0000</td>
                <td>0.8996</td>
                <td>1.0000</td>
                <td></td>
                <td>0.9490</td>
              </tr>
              <tr>
                <td>FSRCNNX_x2_8-0-4-1</td>
                <td>0.0038</td>
                <td>40.9503</td>
                <td>0.9882</td>
                <td>0.9987</td>
                <td></td>
                <td>0.9025</td>
                <td>0.9847</td>
                <td>0.9767</td>
                <td>0.9026</td>
                <td></td>
                <td>0.9416</td>
              </tr>
              <tr>
                <td>ravu-zoom-ar-r2</td>
                <td>0.0037</td>
                <td>40.4133</td>
                <td>0.9874</td>
                <td>0.9986</td>
                <td></td>
                <td>0.9300</td>
                <td>0.8932</td>
                <td>0.9163</td>
                <td>0.8943</td>
                <td></td>
                <td>0.9085</td>
              </tr>
              <tr>
                <td>ravu-zoom-r2</td>
                <td>0.0039</td>
                <td>40.4724</td>
                <td>0.9866</td>
                <td>0.9989</td>
                <td></td>
                <td>0.8399</td>
                <td>0.9033</td>
                <td>0.8578</td>
                <td>0.9714</td>
                <td></td>
                <td>0.8931</td>
              </tr>
              <tr>
                <td>FSRCNNX_x2_16-0-4-1</td>
                <td>0.0040</td>
                <td>39.9168</td>
                <td>0.9873</td>
                <td>0.9984</td>
                <td></td>
                <td>0.8062</td>
                <td>0.8087</td>
                <td>0.9131</td>
                <td>0.8212</td>
                <td></td>
                <td>0.8373</td>
              </tr>
              <tr>
                <td>nnedi3-nns64-win8x4</td>
                <td>0.0044</td>
                <td>38.6337</td>
                <td>0.9839</td>
                <td>0.9973</td>
                <td></td>
                <td>0.6680</td>
                <td>0.5903</td>
                <td>0.6719</td>
                <td>0.4618</td>
                <td></td>
                <td>0.5980</td>
              </tr>
              <tr>
                <td>nnedi3-nns32-win8x4</td>
                <td>0.0045</td>
                <td>38.5214</td>
                <td>0.9835</td>
                <td>0.9973</td>
                <td></td>
                <td>0.6502</td>
                <td>0.5711</td>
                <td>0.6444</td>
                <td>0.4515</td>
                <td></td>
                <td>0.5793</td>
              </tr>
              <tr>
                <td>FSR</td>
                <td>0.0051</td>
                <td>39.0008</td>
                <td>0.9817</td>
                <td>0.9981</td>
                <td></td>
                <td>0.4138</td>
                <td>0.6528</td>
                <td>0.5167</td>
                <td>0.7157</td>
                <td></td>
                <td>0.5747</td>
              </tr>
              <tr>
                <td>polar_lanczos</td>
                <td>0.0050</td>
                <td>37.9718</td>
                <td>0.9806</td>
                <td>0.9980</td>
                <td></td>
                <td>0.4547</td>
                <td>0.4776</td>
                <td>0.4342</td>
                <td>0.6683</td>
                <td></td>
                <td>0.5087</td>
              </tr>
              <tr>
                <td>Anime4K_C_S</td>
                <td>0.0056</td>
                <td>36.3773</td>
                <td>0.9783</td>
                <td>0.9972</td>
                <td></td>
                <td>0.2299</td>
                <td>0.2061</td>
                <td>0.2709</td>
                <td>0.4196</td>
                <td></td>
                <td>0.2816</td>
              </tr>
              <tr>
                <td>Anime4K_C_L</td>
                <td>0.0058</td>
                <td>35.9398</td>
                <td>0.9767</td>
                <td>0.9968</td>
                <td></td>
                <td>0.1453</td>
                <td>0.1316</td>
                <td>0.1600</td>
                <td>0.2977</td>
                <td></td>
                <td>0.1837</td>
              </tr>
              <tr>
                <td>Anime4K_C_VL</td>
                <td>0.0059</td>
                <td>35.6782</td>
                <td>0.9766</td>
                <td>0.9963</td>
                <td></td>
                <td>0.1040</td>
                <td>0.0871</td>
                <td>0.1536</td>
                <td>0.1305</td>
                <td></td>
                <td>0.1188</td>
              </tr>
              <tr>
                <td>Anime4K_C_M</td>
                <td>0.0062</td>
                <td>35.3010</td>
                <td>0.9744</td>
                <td>0.9962</td>
                <td></td>
                <td>0.0000</td>
                <td>0.0229</td>
                <td>0.0000</td>
                <td>0.1077</td>
                <td></td>
                <td>0.0326</td>
              </tr>
              <tr>
                <td>Anime4K_C_UL</td>
                <td>0.0061</td>
                <td>35.1667</td>
                <td>0.9750</td>
                <td>0.9959</td>
                <td></td>
                <td>0.0290</td>
                <td>0.0000</td>
                <td>0.0428</td>
                <td>0.0000</td>
                <td></td>
                <td>0.0179</td>
              </tr>
            </tbody>
          </table>
        </p>
    <h3 id="upsampling_commentary">Upsampling Commentary</h3>
    <p>
        The funniest thing about these results is that, according to distortion metrics, Anime4K is actually worse at "recreating the ground truth" than polar Lanczos. 
        The problem seems to be that the shader is too sharp, it does not only ring but also makes the lines thinner. This isn't necessarily bad depending on how blurry your source is, but my test image here isn't 
        blurry at all.
    </p>
    <p>
        The slower variant of FSRCNNX has also scored worse than its smaller sibling, presumably for the same reason. I don't think igv trained these networks with images that had been downsampled in linear light, so that's probably part 
        of the problem.
    </p>
    <p>
        The overly-sharp shaders would probably do much better on perceptual metrics, I'll evaluate whether adding a few of them to the benchmarking script makes sense on a later date.
    </p>
    <p>
        It's nice to see that bjin came back from the dead with gold. The new ravu variants perform much better than their previous incarnations and they're also free of the half-pixel shift problem.
    </p>
    <p>
      ravu-zoom-ar-r3 seems to be the clear winner here when it comes to reconstruction, beating even FSRCNNX which is a CNN. The numbers are incredibly close though, so if you're looking for a shader it wouldn't hurt to them both of them to a test drive.
    </p>
    <h3 id="fractional_upsampling">Fractional Upsampling</h3>
    <p>
      While doing these tests at 2x makes sense since we can use a box filter to downsample, most people aren't always doubling their content. Scaling "performance" at lower scaling factors, such as 1.5x or 1.33x, are usually more interesting 
      because this corresponds to 720p->1080p and 1080p->1440p, respectively. This section is supposed to better represent a real world scenario when you don't have a 4K display or don't watch comically low-resolution content.
    </p>
    <h3 id="fractional_upsampling_methodology">Fractional Upsampling Methodology</h3>
    <p>
      Unfortunately, some of my choices here are only explained in the following sections. You'll have to bear with me and trust this makes (some) sense, as the alternative would be placing the fractional upsampling section at the end of the page 
      instead of here, its most logical position.
    </p>
    <p>
      In short, the entire methodology stays the same with a few modifications:
      <ol>
        <li>Downsampling was done from 1080p to 720p using catmull_rom + <a href="https://github.com/Artoriuz/glsl-pixel-clipper">Pixel Clipper</a>.</li>
        <li>The doublers were also downsampled with catmull_rom + Pixel Clipper.</li>
        <li>I've removed Anime4K from this because this is too far removed from what the devs intended it to be used for.</li>
        <li>I've also added one of my memes, a 2-lobes sinc + AR (which is also Pixel Clipper in this case). This combination can sometimes be as sharp as the shaders, but it's prone to aliasing at higher scaling factors.</li>
      </ol>
    </p>
    <h3 id="fractional_upsampling_methodology">Fractional Upsampling Results</h3>
    <p>
      <table>
        <tbody>
          <tr>
            <td>Shader/Filter</td>
            <td>MAE</td>
            <td>PSNR</td>
            <td>SSIM</td>
            <td>MS-SSIM</td>
            <td></td>
            <td>MAE (N)</td>
            <td>PSNR (N)</td>
            <td>SSIM (N)</td>
            <td>MS-SSIM (N)</td>
            <td></td>
            <td>Mean</td>
          </tr>
          <tr>
            <td>FSRCNNX_x2_8-0-4-1_catrom_pc</td>
            <td>0.0028</td>
            <td>44.0656</td>
            <td>0.9929</td>
            <td>0.9992</td>
            <td></td>
            <td>1.0000</td>
            <td>0.9702</td>
            <td>0.9894</td>
            <td>1.0000</td>
            <td></td>
            <td>0.9899</td>
          </tr>
          <tr>
            <td>FSRCNNX_x2_16-0-4-1_catrom_pc</td>
            <td>0.0030</td>
            <td>44.1704</td>
            <td>0.9930</td>
            <td>0.9992</td>
            <td></td>
            <td>0.9244</td>
            <td>1.0000</td>
            <td>1.0000</td>
            <td>0.9810</td>
            <td></td>
            <td>0.9764</td>
          </tr>
          <tr>
            <td>ravu-zoom-r3</td>
            <td>0.0030</td>
            <td>43.7155</td>
            <td>0.9920</td>
            <td>0.9992</td>
            <td></td>
            <td>0.9222</td>
            <td>0.8708</td>
            <td>0.8647</td>
            <td>0.9980</td>
            <td></td>
            <td>0.9139</td>
          </tr>
          <tr>
            <td>ravu-zoom-ar-r3</td>
            <td>0.0028</td>
            <td>43.6141</td>
            <td>0.9922</td>
            <td>0.9991</td>
            <td></td>
            <td>0.9872</td>
            <td>0.8420</td>
            <td>0.8885</td>
            <td>0.8551</td>
            <td></td>
            <td>0.8932</td>
          </tr>
          <tr>
            <td>ravu-zoom-ar-r2</td>
            <td>0.0029</td>
            <td>43.2579</td>
            <td>0.9918</td>
            <td>0.9990</td>
            <td></td>
            <td>0.9363</td>
            <td>0.7408</td>
            <td>0.8280</td>
            <td>0.8219</td>
            <td></td>
            <td>0.8318</td>
          </tr>
          <tr>
            <td>sinc2_pc4</td>
            <td>0.0030</td>
            <td>43.4463</td>
            <td>0.9916</td>
            <td>0.9990</td>
            <td></td>
            <td>0.8920</td>
            <td>0.7944</td>
            <td>0.7979</td>
            <td>0.7624</td>
            <td></td>
            <td>0.8116</td>
          </tr>
          <tr>
            <td>ravu-zoom-r2</td>
            <td>0.0031</td>
            <td>43.1801</td>
            <td>0.9915</td>
            <td>0.9991</td>
            <td></td>
            <td>0.8505</td>
            <td>0.7187</td>
            <td>0.7818</td>
            <td>0.8936</td>
            <td></td>
            <td>0.8111</td>
          </tr>
          <tr>
            <td>nnedi3-nns64-win8x4_catrom_pc</td>
            <td>0.0032</td>
            <td>42.5336</td>
            <td>0.9913</td>
            <td>0.9989</td>
            <td></td>
            <td>0.7758</td>
            <td>0.5351</td>
            <td>0.7594</td>
            <td>0.7025</td>
            <td></td>
            <td>0.6932</td>
          </tr>
          <tr>
            <td>nnedi3-nns32-win8x4_catrom_pc</td>
            <td>0.0032</td>
            <td>42.5250</td>
            <td>0.9913</td>
            <td>0.9989</td>
            <td></td>
            <td>0.7730</td>
            <td>0.5327</td>
            <td>0.7542</td>
            <td>0.7022</td>
            <td></td>
            <td>0.6905</td>
          </tr>
          <tr>
            <td>polar_lanczos</td>
            <td>0.0035</td>
            <td>41.4071</td>
            <td>0.9894</td>
            <td>0.9988</td>
            <td></td>
            <td>0.5959</td>
            <td>0.2152</td>
            <td>0.4805</td>
            <td>0.5951</td>
            <td></td>
            <td>0.4717</td>
          </tr>
          <tr>
            <td>FSR</td>
            <td>0.0045</td>
            <td>40.6494</td>
            <td>0.9861</td>
            <td>0.9982</td>
            <td></td>
            <td>0.0000</td>
            <td>0.0000</td>
            <td>0.0000</td>
            <td>0.0000</td>
            <td></td>
            <td>0.0000</td>
          </tr>
        </tbody>
      </table>
    </p>
    <h3 id="fractional_upsampling_commentary">Fractional Upsampling Commentary</h3>
    <p>
      Unlike in the 2x test, the new ravu-zoom variants weren't capable of dethroning FSRCNNX this time. Which may sound a bit ironic considering ravu-zoom can output to the target resolution directly while FSRCNNX can't.
    </p>
    <p>
      The numbers are all closer together at 1.5x, which shows that your choice of scaler becomes less relevant as you decrease the scaling factor.
    </p>
    <p>
      It's a bit funny to see FSR get worse here, since a lower scaling factor corresponds to a higher quality preset in AMD's terms, but I think the problem is just that the shader is too sharp. The RCAS step hurts more than it helps here.
    </p>
    <p>
      The 2-lobes sinc + Pixel Clipper scored so high it becomes difficult to recommend any of these shaders unless you are really sensitive to aliasing and can't stand how it looks. However, keep in mind this is an unhinged sinc which is hilariously sharp, it can 
      always be made softer with a window, and in this case I recommend starting with Kaiser (which will still keep it quite sharp). mpv doesn't allow you to set a window for sinc, so just replace the filter with lanczos (radius=2) if you're going to use a window. 
      Please note that I don't actually recommend using this with sources that are naturally a bit blurry. The filter will very aggressively sharpen everything and the AR shader can only remove overshoots, not all the extra sharpening.
    </p>
    <p>
      Polar Lanczos actually managed to score higher than FSR here, but it's still in a different class when compared to basically anything else. This is to be somewhat expected since polar Lanczos is a relatively blurry filter, its strenghts 
      are mostly tied to hiding aliasing which isn't really a major factor at 1.5x.
    </p>
    <h3 id="chroma_shaders">Chroma Shaders</h3>
    <p>
        Using shaders to upsample chroma is an old meme, as igv ported Shiandow's KrigBilateral to mpv years ago. KrigBilateral finds the correlation between luma and chroma, and then maps the missing values based on that. 
        You can read more about it <a href="https://en.wikipedia.org/wiki/Kriging">here</a>.
    </p>
    <p>
        There's a different technique, usually called Joint or Cross Bilateral, that simply uses luma as an extra weighting factor. In short, chromatic information from pixels with similar luminosities is preferred. <a href="">I've written a shader that 
        implements this idea</a> mostly to learn GLSL, but it ended up being quite useful as it's much faster than KrigBilateral while still keeping a clear lead over classic methods.
    </p>
    <p>
        In any case, my goal here is to compare these chroma shaders against polar Lanczos, which I'm using as a reference point.
    </p>
    <h3 id="chroma_methodology">Chroma Methodology</h3>
    <p>
        This test is a little different and it requires a slightly more elaborate process. The first problem with this is that, with real video content, we rarely get a 4:4:4 copy. This means that we generally don't have a reference point 
        to work with, so we have to create one on our own.
    </p>
    <p>
        I've semi-arbitrarily decided to use a downsampled version of <a href="https://twitter.com/fujinoomori/status/1576159422040064001">this danmachi fanart</a>. This image is particularly good at showing the difference between these shaders 
        because it's full of pixel-to-pixel chromatic deviations, specially in the red areas. I might change this to a different test image at a later date, but for now it'll do.
    </p>
    <p>
        This is what the original test image looks like:
    </p>
    <p>
        <img src="./images/mpv_upscaling/chroma/reference.png" alt="chroma_reference" class="center" width="620" height="666">
    </p>
    <p>
        Two versions of the image were created using FFmpeg:
    </p>
    <code>ffmpeg -i downscaled.png -pix_fmt yuv444p10le -c:v libx264 -preset placebo -qp 0 -an danmachi444.mp4</code>
    <br>
    <code>ffmpeg -i downscaled.png -pix_fmt yuv420p10le -c:v libx264 -preset placebo -qp 0 -an danmachi420.mp4</code>
    <p>
        The idea here was creating (nearly) lossless variants with and without chroma subsampling.
    </p>
    <p>
        The "reference" image was obtained by screenshotting "danmachi444.mp4" on mpv.
    </p>
    <p>
        The images under test were obtained by screenshotting "danmachi420.mp4" on mpv using the various chroma resampling shaders.
    </p>
    <p>
        mpv options remains the same with the exception that we don't need <inline_code>--window-scale=2.0</inline_code> anymore. Since we're comparing chroma here, the images weren't converted to grayscale.
    </p>
    <h3 id="chroma_results">Chroma Results</h3>
    <p>
        <table>
            <tbody>
              <tr>
                <td>Shader/Filter</td>
                <td>MAE</td>
                <td>PSNR</td>
                <td>SSIM</td>
                <td>MS-SSIM</td>
                <td></td>
                <td>MAE (N)</td>
                <td>PSNR (N)</td>
                <td>SSIM (N)</td>
                <td>MS-SSIM (N)</td>
                <td></td>
                <td>Mean</td>
              </tr>
              <tr>
                <td>krigbilateral</td>
                <td>0.0025</td>
                <td>41.1124</td>
                <td>0.9941</td>
                <td>0.9994</td>
                <td></td>
                <td>1.0000</td>
                <td>1.0000</td>
                <td>1.0000</td>
                <td>1.0000</td>
                <td></td>
                <td>1.0000</td>
              </tr>
              <tr>
                <td>FastBilateral</td>
                <td>0.0028</td>
                <td>40.0376</td>
                <td>0.9925</td>
                <td>0.9991</td>
                <td></td>
                <td>0.5973</td>
                <td>0.4479</td>
                <td>0.4715</td>
                <td>0.6175</td>
                <td></td>
                <td>0.5335</td>
              </tr>
              <tr>
                <td>JointBilateral</td>
                <td>0.0029</td>
                <td>39.9786</td>
                <td>0.9923</td>
                <td>0.9990</td>
                <td></td>
                <td>0.4964</td>
                <td>0.4176</td>
                <td>0.4033</td>
                <td>0.5301</td>
                <td></td>
                <td>0.4619</td>
              </tr>
              <tr>
                <td>polar_lanczos</td>
                <td>0.0032</td>
                <td>39.1656</td>
                <td>0.9911</td>
                <td>0.9987</td>
                <td></td>
                <td>0.0000</td>
                <td>0.0000</td>
                <td>0.0000</td>
                <td>0.0000</td>
                <td></td>
                <td>0.0000</td>
              </tr>
            </tbody>
        </table>
    </p>
    <h3 id="chroma_commentary">Chroma Commentary</h3>
    <p>
        As expected, the bilateral filters are all capable of getting closer to the ground truth than polar Lanczos. KrigBilateral is the best scorer here, which was also expected given it's the slowest shader.
    </p>
    <p>
        FastBilateral scoring higher than JointBilateral might seem weird at first, but at their default settings (with <inline_code>intensity_coeff = 64.0</inline_code>) this can happen sometimes. JointBilateral takes a neighbourhood 
        of 16 chroma pixels while FastBilateral only uses the 4 surrounding pixels. This much greater radius allows JointBilateral to "look far away", which is usually beneficial but can also work against it when the surrounding pixels 
        are close together in luminance but far apart in chromaticity.
    </p>
    <p>
        My personal advice here is that there's little point in using JointBilateral over FastBilateral, even when it does better the difference is usually negligible. Krig is also better than both of them at the expense of being much slower to run 
        (about an order of magnitude slower than FastBilateral), but if your hardware can handle it then that's a non-issue.
    </p>
    <p>
        The table also shows us that, if you use polar Lanczos as the baseline, Joint/Fast Bilateral are pretty much half-way as good as KrigBilateral. The shaders would be much closer together in the final mean if I had included faster 
        options such as bilinear and box, but there's little reason to use those to scale chroma unless you're really trying to save on resources.
    </p>
    <p>
        The only other thing I'd like to point out here is that the difference between these 3 shaders and the built-in solutions gets bigger when you use luma prescalers, since they use luma information as a guide.
    </p>
    <h3 id="antiring">Antiring</h3>
    <p>
        Antiringing solutions is a topic that I hadn't covered in the previous iteration of this page, but now that we have more than a single option we can also compare them.
    </p>
    <p>
        In short, antiringing filters attempt to remove overshoots generated by sharp resampling filters when they meet a sharp intensity delta. What is commonly referred to as ringing is simply consequential to the filter's impulse response.
    </p>
    <p>
        The following image shows this very well:
    </p>
    <p>
        <img src="./images/mpv_upscaling/antiring/ar_comparison.png" alt="ar_comparison" class="center" width="900" height="300">
    </p>
    <p>
        The negative weights in the filter are there for it to be able to quickly respond to high-frequency transitions, but it makes the filter overshoot a little bit before reaching its final destination. The "intensity" of the ringing is 
        directly related to the magnitude of the secondary lobes. The second lobe, which is almost always negative, is responsible for the overshooting in can see in this example, but filters with more lobes ring once per lobe, and the ringing can 
        be "positive" as well (within the range set by the original pixels) with positive lobes. The "length" of the rings is directly related to the length of the lobes, which is why filters like polar Lanczos have "longer" rings (the zero crossings 
        don't fall exactly at the integers, but rather slightly after them).
    </p>
    <h3 id="antiring_methodology">Antiring Methodology</h3>
    <p>
        The methodology here almost is equal to the one used for upsampling, with the only difference being that we have to include <inline_code>--scale-antiring</inline_code> to use mpv's (or libplacebo's) native AR solution. We also don't have to convert to grayscale 
        this time since the shaders support RGB images just fine.
    </p>
    <p>
        AR is only really necessary when you're using sharp filters, it makes no sense alongside blurry filters because blurry filters don't ring hard enough for it to be noticeable. Polar Lanczos is a relatively blurry filter, and it's probably not 
        the best candidate to test this with, however, it's also the most popular polar choice so using something else probably wouldn't be very useful to a lot of people... There are a few sharp memes that are worth trying with AR though if you feel adventurous, 
        but enerally speaking I think orthogonal lanczos and polar lanczos are pretty balanced.
    </p>
    <p>
        It's also worth mentioning that mpv uses different AR techniques for orthogonal and polar filters, but I'll name them both "_ar" for simplicity.
    </p>
    <p>
        I'm including <a href="https://github.com/Artoriuz/glsl-pixel-clipper">my AR shaders</a> in this comparison because I think they're very good at keeping everything but the overshoots intact, which does create some weird artifacts with sharp transitions sometimes, 
        specially if you use them at ludicrous scaling factors, but the output is generally clean enough on real content.
    </p>
    <h3 id="antiring_results">Antiring Results</h3>
    <p>
      <table>
        <tbody>
          <tr>
            <td>Filter</td>
            <td>MAE</td>
            <td>PSNR</td>
            <td>SSIM</td>
            <td>MS-SSIM</td>
            <td></td>
            <td>MAE (N)</td>
            <td>PSNR (N)</td>
            <td>SSIM (N)</td>
            <td>MS-SSIM (N)</td>
            <td></td>
            <td>Mean</td>
          </tr>
          <tr>
            <td>lanczos_pc4_100</td>
            <td>0.0045</td>
            <td>38.4763</td>
            <td>0.9831</td>
            <td>0.9985</td>
            <td></td>
            <td>1.0000</td>
            <td>0.9818</td>
            <td>1.0000</td>
            <td>0.7774</td>
            <td></td>
            <td>0.9398</td>
          </tr>
          <tr>
            <td>lanczos_pc4_75</td>
            <td>0.0046</td>
            <td>38.4828</td>
            <td>0.9830</td>
            <td>0.9985</td>
            <td></td>
            <td>0.9376</td>
            <td>0.9934</td>
            <td>0.9676</td>
            <td>0.8592</td>
            <td></td>
            <td>0.9395</td>
          </tr>
          <tr>
            <td>lanczos_pc4_50</td>
            <td>0.0047</td>
            <td>38.4633</td>
            <td>0.9827</td>
            <td>0.9986</td>
            <td></td>
            <td>0.7928</td>
            <td>0.9584</td>
            <td>0.8655</td>
            <td>0.9314</td>
            <td></td>
            <td>0.8870</td>
          </tr>
          <tr>
            <td>lanczos_pc12_100</td>
            <td>0.0046</td>
            <td>38.4865</td>
            <td>0.9827</td>
            <td>0.9985</td>
            <td></td>
            <td>0.8127</td>
            <td>1.0000</td>
            <td>0.8646</td>
            <td>0.8572</td>
            <td></td>
            <td>0.8837</td>
          </tr>
          <tr>
            <td>lanczos_pc12_75</td>
            <td>0.0047</td>
            <td>38.4782</td>
            <td>0.9826</td>
            <td>0.9986</td>
            <td></td>
            <td>0.7672</td>
            <td>0.9850</td>
            <td>0.8346</td>
            <td>0.9075</td>
            <td></td>
            <td>0.8736</td>
          </tr>
          <tr>
            <td>lanczos_pc12_50</td>
            <td>0.0047</td>
            <td>38.4522</td>
            <td>0.9824</td>
            <td>0.9986</td>
            <td></td>
            <td>0.6723</td>
            <td>0.9387</td>
            <td>0.7577</td>
            <td>0.9554</td>
            <td></td>
            <td>0.8310</td>
          </tr>
          <tr>
            <td>lanczos_ar_50</td>
            <td>0.0047</td>
            <td>38.3433</td>
            <td>0.9826</td>
            <td>0.9985</td>
            <td></td>
            <td>0.7602</td>
            <td>0.7442</td>
            <td>0.8129</td>
            <td>0.8172</td>
            <td></td>
            <td>0.7836</td>
          </tr>
          <tr>
            <td>lanczos_ar_75</td>
            <td>0.0046</td>
            <td>38.2819</td>
            <td>0.9827</td>
            <td>0.9984</td>
            <td></td>
            <td>0.8564</td>
            <td>0.6345</td>
            <td>0.8472</td>
            <td>0.6661</td>
            <td></td>
            <td>0.7511</td>
          </tr>
          <tr>
            <td>lanczos</td>
            <td>0.0048</td>
            <td>38.3682</td>
            <td>0.9819</td>
            <td>0.9986</td>
            <td></td>
            <td>0.4568</td>
            <td>0.7886</td>
            <td>0.5388</td>
            <td>1.0000</td>
            <td></td>
            <td>0.6961</td>
          </tr>
          <tr>
            <td>lanczos_ar_100</td>
            <td>0.0046</td>
            <td>38.1854</td>
            <td>0.9826</td>
            <td>0.9983</td>
            <td></td>
            <td>0.8767</td>
            <td>0.4622</td>
            <td>0.8150</td>
            <td>0.4950</td>
            <td></td>
            <td>0.6622</td>
          </tr>
          <tr>
            <td>polar_lanczos_ar_75</td>
            <td>0.0047</td>
            <td>38.0348</td>
            <td>0.9818</td>
            <td>0.9982</td>
            <td></td>
            <td>0.6240</td>
            <td>0.1933</td>
            <td>0.5137</td>
            <td>0.1963</td>
            <td></td>
            <td>0.3818</td>
          </tr>
          <tr>
            <td>polar_lanczos_pc4_100</td>
            <td>0.0048</td>
            <td>38.0367</td>
            <td>0.9817</td>
            <td>0.9982</td>
            <td></td>
            <td>0.5667</td>
            <td>0.1966</td>
            <td>0.4694</td>
            <td>0.2895</td>
            <td></td>
            <td>0.3806</td>
          </tr>
          <tr>
            <td>polar_lanczos_pc4_75</td>
            <td>0.0048</td>
            <td>38.0387</td>
            <td>0.9816</td>
            <td>0.9983</td>
            <td></td>
            <td>0.4970</td>
            <td>0.2003</td>
            <td>0.4300</td>
            <td>0.3567</td>
            <td></td>
            <td>0.3710</td>
          </tr>
          <tr>
            <td>polar_lanczos_ar_50</td>
            <td>0.0048</td>
            <td>38.0317</td>
            <td>0.9816</td>
            <td>0.9983</td>
            <td></td>
            <td>0.4771</td>
            <td>0.1878</td>
            <td>0.4312</td>
            <td>0.3372</td>
            <td></td>
            <td>0.3583</td>
          </tr>
          <tr>
            <td>polar_lanczos_ar_100</td>
            <td>0.0047</td>
            <td>38.0045</td>
            <td>0.9818</td>
            <td>0.9981</td>
            <td></td>
            <td>0.6297</td>
            <td>0.1392</td>
            <td>0.5035</td>
            <td>0.0000</td>
            <td></td>
            <td>0.3181</td>
          </tr>
          <tr>
            <td>polar_lanczos_pc12_100</td>
            <td>0.0049</td>
            <td>38.0394</td>
            <td>0.9813</td>
            <td>0.9983</td>
            <td></td>
            <td>0.3817</td>
            <td>0.2015</td>
            <td>0.3319</td>
            <td>0.3539</td>
            <td></td>
            <td>0.3173</td>
          </tr>
          <tr>
            <td>polar_lanczos_pc4_50</td>
            <td>0.0049</td>
            <td>38.0185</td>
            <td>0.9813</td>
            <td>0.9983</td>
            <td></td>
            <td>0.3487</td>
            <td>0.1642</td>
            <td>0.3231</td>
            <td>0.4145</td>
            <td></td>
            <td>0.3126</td>
          </tr>
          <tr>
            <td>polar_lanczos_pc12_75</td>
            <td>0.0049</td>
            <td>38.0308</td>
            <td>0.9812</td>
            <td>0.9983</td>
            <td></td>
            <td>0.3322</td>
            <td>0.1861</td>
            <td>0.2989</td>
            <td>0.3935</td>
            <td></td>
            <td>0.3027</td>
          </tr>
          <tr>
            <td>polar_lanczos_pc12_50</td>
            <td>0.0049</td>
            <td>38.0061</td>
            <td>0.9810</td>
            <td>0.9983</td>
            <td></td>
            <td>0.2309</td>
            <td>0.1421</td>
            <td>0.2164</td>
            <td>0.4286</td>
            <td></td>
            <td>0.2545</td>
          </tr>
          <tr>
            <td>polar_lanczos</td>
            <td>0.0050</td>
            <td>37.9266</td>
            <td>0.9804</td>
            <td>0.9983</td>
            <td></td>
            <td>0.0000</td>
            <td>0.0000</td>
            <td>0.0000</td>
            <td>0.4546</td>
            <td></td>
            <td>0.1137</td>
          </tr>
        </tbody>
      </table>
    </p>
    <h3 id="antiring_commentary">Antiring Commentary</h3>
    <p>
        Previously, this section talked about the different strengths and weaknesses of Pixel Clipper and libplacebo's AR, but that's not really neccessary anymore. 
        Libplacebo's AR has been <a href="https://code.videolan.org/videolan/libplacebo/-/commit/7fb12078b8f0e212f1cc3f5631fb891b3a08ca1c">recently updated</a> and it looks great now. It's actually shocking 
        how similar the solutions look considering how different the mechanisms are.
    </p>
    <p>
      The only caveat is that libplacebo's AR is still a bit blurrier at similar strength, so you probably have to dial it down a little bit to preserve sharpness (0.75 seems to be a good starting point). 
      Libplacebo's AR is also still a bit slower than Pixel Clipper, but if you can run polar filters I don't expect polar AR to be a big problem. 
    </p>
    <p>
      It really looks like you can't go wrong with either option, so just pick your poison. Libplacebo's AR, however, is the most sophisticated algorithm here. It is supposed to be better and it's likely that haasn will keep polishing it. 
      Pixel Clipper is very simple, it simply clips, which can create some instantaneous transitions sometimes. Libplacebo's AR uses the first lobe of the resampling filter so it's naturally smooth and mostly free of high-frequency artifacts 
      (again, at the expense of being slightly blurrier).
    </p>
    <p>
        mpv's native AR solution for orthogonal filters shouldn't blur anything though, and I believe Pixel Clipper is only scoring higher than it because mpv applies its antiring twice, once per orthogonal pass. This means that the second pass 
        won't have access to the overshoots created by the first pass, which is theoretically a good thing but actually ends up hurting the filter's reconstruction quality. Pixel Clipper is only applied after scaling is done, so it's completely 
        oblivious to the entire scaling process. It simply clamps the HR pixels to the intensity bounds set by the surrounding LR pixels.
    </p>
    <p>
        I've personally started using Pixel Clipper with orthogonal filters recently but then again the difference isn't that big, the built-in solution also works well enough.
    </p>
    <h3 id="downsampling_antiring">Downsampling Antiring</h3>
    <p>
        Pixel Clipper actually has a downsampling variant as well, which I believe is probably less broken than mpv's native <inline_code>--dscale-antiring</inline_code> solution for orthogonal filters. 
        Libplacebo's new polar AR has been recently enabled for downsampling as well, so we can also test that here. I'm skipping doing these tests at different strengths though, as throwing away unwanted information should be 
        easier when downsampling.
    </p>
    <p>
        I'm only including mitchell, catrom, spline36, lanczos and polar lanczos in this section, as these are the most popular choices for downsampling. 
        The following image was used for the downsampling tests:
    </p>
    <img src="./images/mpv_upscaling/downsampling/highres.png" alt="yurucamp" class="center" width="960" height="540">
    <h3 id="downsampling_antiring_methodology">Downsampling Antiring Methodology</h3>
    <p>
        My current method to evaluate downsampling filters is to concede that at 0.5x linear light box is as good as it gets, since in this case we're just averaging 4 pixels together. 
        We can't use box itself for other scaling factors though, so the aim is to find a filter that produces a similar result but is also usable at any other arbitrary scaling factor.
    </p>
    <p>
        To eliminate any differences caused by how differently mpv and ImageMagick perform linear light conversion, the box reference was also obtained using mpv.
    </p>
    <p>
        The images were basically generated using the following commands:
    </p>
    <code>mpv --no-config --vo=gpu-next --no-hidpi-window-scale --window-scale=0.5 --pause=yes --screenshot-format=png --linear-downscaling --correct-downscaling --deband=no --dither-depth=no --screenshot-high-bit-depth=no --dscale=filter --glsl-shader="Pixel Clipper_downscaling.glsl" higres.png</code>
    <code>mpv --no-config --vo=gpu-next --no-hidpi-window-scale --window-scale=0.5 --pause=yes --screenshot-format=png --linear-downscaling --correct-downscaling --deband=no --dither-depth=no --screenshot-high-bit-depth=no --dscale=ewa_lanczos --scale-antiring=1 higres.png</code>
    <p>
      Please note that you have to set <inline_code>--scale-antiring=1</inline_code> instead of <inline_code>--dscale-antiring=1</inline_code>. That's probably a bug but it is what it is.
    </p>
    <h3 id="downsampling_antiring_results">Downsampling Antiring Results</h3>
    <p>
      <table>
        <tbody>
          <tr>
            <td>Filter</td>
            <td>MAE</td>
            <td>PSNR</td>
            <td>SSIM</td>
            <td>MS-SSIM</td>
            <td></td>
            <td>MAE (N)</td>
            <td>PSNR (N)</td>
            <td>SSIM (N)</td>
            <td>MS-SSIM (N)</td>
            <td></td>
            <td>Mean</td>
          </tr>
          <tr>
            <td>catrom_pc</td>
            <td>0.0026</td>
            <td>42.0780</td>
            <td>0.9955</td>
            <td>0.9996</td>
            <td></td>
            <td>1.0000</td>
            <td>1.0000</td>
            <td>1.0000</td>
            <td>1.0000</td>
            <td></td>
            <td>1.0000</td>
          </tr>
          <tr>
            <td>lanczos_pc</td>
            <td>0.0027</td>
            <td>42.0482</td>
            <td>0.9950</td>
            <td>0.9994</td>
            <td></td>
            <td>0.9317</td>
            <td>0.9949</td>
            <td>0.9324</td>
            <td>0.8756</td>
            <td></td>
            <td>0.9337</td>
          </tr>
          <tr>
            <td>spline36_pc</td>
            <td>0.0028</td>
            <td>41.8381</td>
            <td>0.9949</td>
            <td>0.9995</td>
            <td></td>
            <td>0.9135</td>
            <td>0.9593</td>
            <td>0.9190</td>
            <td>0.8935</td>
            <td></td>
            <td>0.9213</td>
          </tr>
          <tr>
            <td>catrom</td>
            <td>0.0030</td>
            <td>40.5637</td>
            <td>0.9948</td>
            <td>0.9994</td>
            <td></td>
            <td>0.8359</td>
            <td>0.7433</td>
            <td>0.8997</td>
            <td>0.8645</td>
            <td></td>
            <td>0.8358</td>
          </tr>
          <tr>
            <td>polar_lanczos_ar</td>
            <td>0.0035</td>
            <td>39.8136</td>
            <td>0.9924</td>
            <td>0.9992</td>
            <td></td>
            <td>0.6224</td>
            <td>0.6161</td>
            <td>0.5752</td>
            <td>0.6304</td>
            <td></td>
            <td>0.6110</td>
          </tr>
          <tr>
            <td>polar_lanczos_pc</td>
            <td>0.0036</td>
            <td>39.6853</td>
            <td>0.9921</td>
            <td>0.9992</td>
            <td></td>
            <td>0.5603</td>
            <td>0.5944</td>
            <td>0.5361</td>
            <td>0.6285</td>
            <td></td>
            <td>0.5798</td>
          </tr>
          <tr>
            <td>spline36</td>
            <td>0.0038</td>
            <td>38.3021</td>
            <td>0.9923</td>
            <td>0.9991</td>
            <td></td>
            <td>0.4865</td>
            <td>0.3599</td>
            <td>0.5598</td>
            <td>0.4963</td>
            <td></td>
            <td>0.4756</td>
          </tr>
          <tr>
            <td>mitchell_pc</td>
            <td>0.0038</td>
            <td>38.1842</td>
            <td>0.9908</td>
            <td>0.9990</td>
            <td></td>
            <td>0.4950</td>
            <td>0.3399</td>
            <td>0.3609</td>
            <td>0.3793</td>
            <td></td>
            <td>0.3938</td>
          </tr>
          <tr>
            <td>lanczos</td>
            <td>0.0039</td>
            <td>37.7231</td>
            <td>0.9917</td>
            <td>0.9990</td>
            <td></td>
            <td>0.4353</td>
            <td>0.2618</td>
            <td>0.4862</td>
            <td>0.3669</td>
            <td></td>
            <td>0.3876</td>
          </tr>
          <tr>
            <td>mitchell</td>
            <td>0.0038</td>
            <td>38.1312</td>
            <td>0.9907</td>
            <td>0.9990</td>
            <td></td>
            <td>0.4731</td>
            <td>0.3309</td>
            <td>0.3522</td>
            <td>0.3727</td>
            <td></td>
            <td>0.3822</td>
          </tr>
          <tr>
            <td>polar_lanczos</td>
            <td>0.0050</td>
            <td>36.1789</td>
            <td>0.9881</td>
            <td>0.9987</td>
            <td></td>
            <td>0.0000</td>
            <td>0.0000</td>
            <td>0.0000</td>
            <td>0.0000</td>
            <td></td>
            <td>0.0000</td>
          </tr>
        </tbody>
      </table>
    </p>
    <h3 id="downsampling_antiring_commentary">Downsampling Antiring Commentary</h3>
    <p>
        The first thing we can see is that AR seems to be a net-positive in general. All filters scored higher with AR, with the sharpest filter in the comparison (Lanczos) seeing the biggest improvement. 
    </p>
    <p>
        Catrom is the highest scoring filter with and without AR, so it's easy to recommend this unless you really prefer the softer look of mitchell.
    </p>
    <p>
        Mitchell itself also saw a small improvement with AR, but using AR with mitchell is completely unnecessary and you're unlikely to notice the difference.
    </p>
    <p>
        It's also good to see that libplacebo's AR seems to work even better when downsampling, as it can remove ringing without introducing any significant blur. Between it and Pixel Clipper just stick with the native solution 
        unless Pixel Clipper is significantly faster on your machine. I wouldn't exactly recommend using polar lanczos for downsampling though, orthogonal catrom is not only better but also much faster.
    </p>
    <h3 id="outro">Outro</h3>
    <p>
        I want to make it clear though that you shouldn't take the results as gospel. Mathematical image quality metrics do not always correlate perfectly with how humans perceive image quality, 
        and your personal preference is entirely subjective. You should take this page as what it is, a research that produces numbers, but you should not take these numbers for granted before 
        understanding what they actually mean.
    </p>
</section>
        <br>
        <br>
        <nav>
            <menu>
                <a href="../index.html">Home</a>
                <a href="#introduction">Introduction</a>
                <a href="https://github.com/Artoriuz">GitHub</a>
                <a href="https://www.linkedin.com/in/jvrchrisostomo/">LinkedIn</a>
            </menu>
        </nav>
        <br>
        <br>
</body>
</html>
